@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if (Anchor is not null)
{
    <span style="display: inline-block" @ref="_anchorRef">
        @Anchor
    </span>
}

@if (Open)
{
    <PopperPortal>
        <span @ref="_contentRef">
            @Content
        </span>
    </PopperPortal>
}

@code {
    [Parameter] public RenderFragment? Anchor { get; set; }
    [Parameter, EditorRequired] public RenderFragment Content { get; set; } = default!;
    [Parameter] public bool AutoClose { get; set; }
    [Parameter] public (int x, int y)? Offset { get; set; }
    [Parameter] public Modifier[] Modifiers { get; set; } = { };

    [Parameter] public bool Open { get; set; }
    [Parameter] public EventCallback<bool> OpenChanged { get; set; }

    [Parameter] public Placement Placement { get; set; }
    
    private Guid _instanceId = Guid.NewGuid();

    private Placement? _previousPlacement;
    private bool? _wasOpen;
    
    private ElementReference _anchorRef;
    private ElementReference _contentRef;

    private PopperInterop _popperInterop;

    protected override void OnInitialized()
    {
        _popperInterop = new PopperInterop(JSRuntime);
        _popperInterop.OnClosed += HidePopper;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        //TODO: work out why this is necessary
        await Task.Yield();

        if (Open && (!_wasOpen.HasValue || !_wasOpen.Value))
        {
            //Wasn't open, now is
            Console.WriteLine("Wasn't open, now is");
            await _popperInterop.Create(_instanceId, _anchorRef, _contentRef, Placement, GetModifiers(), AutoClose);
        }
        if (!Open && _wasOpen.HasValue && _wasOpen.Value)
        {
            //Was open, now isn't
            Console.WriteLine("Was open, now isn't");
            await _popperInterop.Destroy(_instanceId);
        }
        
        //Properties have changed, need to update popper instance
        //Has to be open, has to have been rendered at least once before
        if (Open && OptionsHaveChanged())
        {
            await _popperInterop.Update(_instanceId, _contentRef, Placement, GetModifiers(), Open && AutoClose);
        }

        _wasOpen = Open;
        _previousPlacement = Placement;
    }

    private bool OptionsHaveChanged()
    {
        if (_previousPlacement.HasValue && Placement != _previousPlacement.Value)
        {
            return true;
        }


        return false;
    }

    private Modifier[] GetModifiers()
    {
        var modifiers = new List<Modifier>(Modifiers);
        if (Offset.HasValue)
        {
            modifiers.Add(new OffsetModifier(Offset.Value.x, Offset.Value.y));
        }
        return modifiers.ToArray();
    }

    private async Task HidePopper()
    {
        Open = false;
        await OpenChanged.InvokeAsync(Open);
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        await _popperInterop.Destroy(_instanceId);
        await _popperInterop.DisposeAsync();
    }

}
